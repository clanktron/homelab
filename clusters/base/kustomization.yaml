apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- apps/
- default-namespaces/
- cert-manager.yaml
- kubed.yaml
- monitoring.yaml
- traefikk.yaml


patches:
  - target:
      group: kustomize.toolkit.fluxcd.io
      version: v1
      kind: Kustomization
    patch: |
      - op: add
        path: /metadata/namespace
        value: flux-system
      - op: add
        path: /spec
        value:
          sourceRef:
            kind: GitRepository
            name: flux-system
          decryption:
            provider: sops
            secretRef:
              name: sops-age
          interval: 10m
          prune: true
          timeout: 10m

  - target:
      group: kustomize.toolkit.fluxcd.io
      version: v1
      kind: Kustomization
    patch: |-
      [
        {
          "op": "add",
          "path": "/spec/postBuild/substituteFrom/0",
          "value": {
              "kind": "ConfigMap",
              "name": "global-config"
          }
        }
      ]
