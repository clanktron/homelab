apiVersion: v1
kind: Namespace
metadata:
  name: traefik-external

---
kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: allow-all
  namespace: traefik-external
spec:
  podSelector: {}
  ingress:
  - from:
    # Allow all ingress (K8S ingress)
    - ipBlock:
        cidr: "0.0.0.0/0"
  egress:
  - to:
    # Allow egress to Internet (oauth)
    - ipBlock:
        cidr: "0.0.0.0/0"
  policyTypes:
    - Ingress
    - Egress

---
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: traefik-external
spec:
  path: "./core/traefik"
  dependsOn:
    - name: metallb-ip-pool
  postBuild:
    substituteFrom: []
  patches:
    - patch: |-
        - op: replace
          path: /metadata/name
          value: traefik-external
        - op: add
          path: /spec/values
          value:
            ingressClass:
              enabled: true
              isDefaultClass: true
            ingressRoute:
              dashboard:
                enabled: false
                annotations: {}
                labels: {}
            service:
              spec:
                loadBalancerIP: ${EXTERNAL_LB_IP}
            providers:
              kubernetesCRD:
                enabled: true
                allowCrossNamespace: true
                allowExternalNameServices: true
                allowEmptyServices: true
              kubernetesIngress:
                enabled: true
                allowExternalNameServices: true
                allowEmptyServices: true
            ports:
              traefik:
                port: 9000
                expose: false
                exposedPort: 9000
                protocol: TCP
              web:
                port: 8000
                expose: true
                exposedPort: 80
                protocol: TCP
              websecure:
                port: 8443
                expose: true
                exposedPort: 443
                protocol: TCP
              metrics:
                port: 9100
                expose: false
                exposedPort: 9100
                protocol: TCP
            logs:
              general:
                level: DEBUG
              access:
                enabled: true
                filters: {}
                fields:
                  general:
                    defaultmode: keep
                  headers:
                    defaultmode: keep
      target:
        kind: HelmRelease
        name: traefik
