apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- ../base
- ./apps
- ./core

generatorOptions:
  disableNameSuffixHash: true

configMapGenerator:
  - name: global-config
    namespace: flux-system
    literals:
      - EXTERNAL_DOMAIN="staging.claytonc.dev"
      - INTERNAL_DOMAIN="local.staging.claytonc.dev"
      - EXTERNAL_INGRESS="traefik-traefik-external"
      - INTERNAL_INGRESS="traefik-traefik-internal"

patches:
  - target:
      group: kustomize.toolkit.fluxcd.io
      version: v1
      kind: Kustomization
    patch: |
      - op: add
        path: /metadata/namespace
        value: flux-system
      - op: add
        path: /spec
        value:
          timeout: 10m
          prune: true
          interval: 10m
          sourceRef:
            kind: GitRepository
            name: flux-system
          decryption:
            provider: sops
            secretRef:
              name: sops-age
          postBuild:
            substituteFrom:
              - kind: ConfigMap
                name: global-config
